Getting Started with Annotation
###############################



Get Genomic Scores Database
+++++++++++++++++++++++++++

To annotate variants with genomic scores, you will need a genomic scores
database or at least genomic scores you plan to use. You can find some
genomic scores for HG19 `here <https://iossifovlab.com/distribution/public/genomic-scores-hg19/>`_.

Navigate to the genomic-scores-hg19 folder:

.. code::

    cd gpf_test/genomic-scores-hg19


Download and untar the genomic scores you want to use. For example, if you want to use
`gnomAD_exome` and `MPC` frequencies:

.. code:: bash

    wget -c https://iossifovlab.com/distribution/public/genomic-scores-hg19/gnomAD_exome-hg19-latest.tar
    wget -c https://iossifovlab.com/distribution/public/genomic-scores-hg19/MPC-hg19-latest.tar
    tar xvf gnomAD_exome-hg19-latest.tar
    tar xvf MPC-hg19-latest.tar

This will create two subdirectories inside the ``genomic-scores-hg19``
directory, which contain `gnomAD_exome` frequencies and `MPC` genomic scores
prepared to be used by the GPF annotation pipeline and import tools.

Annotation configuration
++++++++++++++++++++++++

If you want to use genomic scores for annotation of the variants
you are importing, you must make appropriate changes in the GPF annotation
pipeline configuration file:

.. code::

    gpf_test/annotation.conf

Below is a sample config for annotating with MPC, gnomAD exome and gnomAD genome
scores. Overwrite the current config with the snippet below.

.. code::

    [vars]
    scores_hg19_dir = "/home/user/gpf_test/genomic-scores-hg19"

    ##############################
    [[sections]]

    annotator = "effect_annotator.VariantEffectAnnotator"

    options.mode = "replace"

    columns.effect_type = "effect_type"

    columns.effect_genes = "effect_genes"
    columns.effect_gene_genes = "effect_gene_genes"
    columns.effect_gene_types = "effect_gene_types"

    columns.effect_details = "effect_details"
    columns.effect_details_transcript_ids = "effect_details_transcript_ids"
    columns.effect_details_details = "effect_details_details"

    ##############################
    [[sections]]

    annotator = "score_annotator.NPScoreAnnotator"

    options.scores_file = "%(scores_hg19_dir)s/MPC/fordist_constraint_official_mpc_values_v2.txt.gz"

    columns.MPC = "mpc"

    ##############################
    [[sections]]

    annotator = "frequency_annotator.FrequencyAnnotator"

    options.scores_file = "%(scores_hg19_dir)s/gnomAD_exome/gnomad.exomes.r2.1.sites.tsv.gz"

    columns.AF = "exome_gnomad_af"
    columns.AF_percent = "exome_gnomad_af_percent"

    columns.AC = "exome_gnomad_ac"
    columns.AN = "exome_gnomad_an"
    columns.controls_AC = "exome_gnomad_controls_ac"
    columns.controls_AN = "exome_gnomad_controls_an"
    columns.controls_AF = "exome_gnomad_controls_af"
    columns.non_neuro_AC = "exome_gnomad_non_neuro_ac"
    columns.non_neuro_AN = "exome_gnomad_non_neuro_an"
    columns.non_neuro_AF = "exome_gnomad_non_neuro_af"
    columns.controls_AF_percent = "exome_gnomad_controls_af_percent"
    columns.non_neuro_AF_percent = "exome_gnomad_non_neuro_af_percent"

.. note::
    The genomic scores folders inside the directory generated by
    ``wdae_bootstrap.sh`` - ``genomic-scores-hg19`` and ``genomic-scores-hg38`` are
    the default locations where the annotation pipeline will resolve the
    interpolation strings ``%(scores_hg19_dir)s`` and
    ``%(scores_hg38_dir)s``, respectively. These interpolation strings are used
    when specifying the location of the genomic score source file to use
    (e.g. ``%(scores_hg19_dir)s/CADD/CADD.bedgraph.gz``).

    You can put your genomic scores inside these directories, or you can specify a
    custom ``scores_hg19_dir`` path at the top of the annotation configuration
    file. Note that this will break genomic scores which were configured
    using the old path.


After updating the annotation configuration file,
we need to reimport the studies in order for the changes to take effect.
To demonstrate, let's reimport the `iossifov_2014` study. Go to the directory
in which you downloaded it:

.. code::

    cd iossifov_2014/

And run the ``simple_study_import.py`` command: 

.. code::

    simple_study_import.py IossifovWE2014.ped \
        --id iossifov_2014 \
        --denovo-file IossifovWE2014.tsv

After the import is finished, restart the GPF web server:

.. code::

    wdaemanage.py runserver 0.0.0.0:8000
